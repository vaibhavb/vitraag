
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet">
<link rel="stylesheet" href="https://www.vitraag.com//assets/css/mybulma.css">
<script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js"></script>

    <title>Kubernetes The Beast</title>
  </head>
<body>

<!---------------------------------------------------->  
<!--               Navbar Section                   -->  
<!---------------------------------------------------->  
<nav class="navbar is-link is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container is-fluid">
    <div class="navbar-brand">
        <!--
          <a class="navbar-item" href="https://www.vitraag.com/">
              <i class="fas fa-home fa-3x"></i>&nbsp;&nbsp;
              <title class="navbar-item" href="https://www.vitraag.com/">Vaibhav Bhandari</title>
          </a>
        -->
        <a class="navbar-burger" data-target="navMenu" role="button" aria-label="menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </a>
    </div>
        <div class="navbar-menu" id="navMenu" >
          <div class="navbar-end">
            <a class="navbar-item" href="https://www.vitraag.com/#about">
              <span class="icon">
                <i class="fas fa-info"></i>
              </span>
              <span>About</span>
            </a>
            <a class="navbar-item" href="https://www.vitraag.com/#portfolio">
                <span class="icon">
                  <i class="fas fa-th-list"></i>
                </span>
                <span>Portfolio</span>
            </a>
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">Blog</a>
              <div class="navbar-dropdown">
                <a href="/#blog" class="navbar-item">Posts By Category&nbsp;<span class="tag is-info">Blogs!</span></a>
                <a href="/posts-by-year" class="navbar-item">Posts By Year&nbsp;<span class="tag is-info">Blogs!</span></a>
              
                <a href="/projects-by-year" class="navbar-item">Projects By Year&nbsp;<span class="tag is-danger">New!</span></a>
                <a href="/travels" class="navbar-item">Travels By Year&nbsp;<span class="tag is-danger">New!</span></a>
              </div>
            </div>
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">Pages</a>
              <div class="navbar-dropdown">
                <a href="https://www.vitraag.com/#ethics" class="navbar-item">       
                  <span class="icon">
                    <i class="fas fa-balance-scale"></i>
                  </span>
                  <span>Ethics&nbsp;</span>
                  <span class="tag is-primary">Life</span>
                </a>
                <a href="/kamal" class="navbar-item">2022 Moms Gratitude Ceremony&nbsp;<span class="tag is-primary">Family</span></a>
                <a href="/posts-by-year" class="navbar-item">Posts By Year&nbsp;<span class="tag is-info">Blogs!</span></a>
                <a href="/recipes" class="navbar-item">Family Recipes&nbsp;<span class="tag is-info">New!</span></a>
                <a href="https://vitraag.notion.site/Vaibhav-s-Public-Notion-Landing-Page-c24d42742ebc43d28ce2e22d41c3ba11" target="_blank" class="navbar-item">Notion &nbsp;<span class="tag is-info">Wiki</span></a>
                <a href="/notes/cats/" class="navbar-item">Second Brain&nbsp;<span class="tag is-info">Memory!</span></a>
                <a href="/test-todo-app/" class="navbar-item">Todo App</a>
                <a href="/me/" class="navbar-item">Me (Visual)</a>
              </div>
            </div>
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">Projects</a>
              <div class="navbar-dropdown">
                <a href="https://www.cyberdefendersprogram.com" class="navbar-item" target="_blank">Cyber Defenders&nbsp;<span class="tag is-primary">Non-Profit</span></a>
                <a href="https://www.lib13.com" class="navbar-item" target="_blank">Lib13 &nbsp;<span class="tag is-primary">Inc</span></a>
                <a href="/digitalhealthconcierge" class="navbar-item">Digital Concierge&nbsp;<span class="tag is-info">Community!</span></a>
                <a href="/code/lira" class="navbar-item">Project Lira&nbsp;<span class="tag is-info">Code!</span></a>
                <a href="https://www.wisevoter.org" target="_blank" class="navbar-item">WiseVoter&nbsp;<span class="tag is-danger">Non-Profit!</span></a>
                <a href="/art" class="navbar-item">Art Work&nbsp;<span class="tag is-info">New!</span></a>
                <a href="/projects-by-year" class="navbar-item">Projects By Year&nbsp;<span class="tag is-danger">New!</span></a>
              </div>
            </div>
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">
                  <span class="icon">
                    <i class="fa fa-archive"></i>
                  </span>
                  <span>Archive</span>
              </a>
              <div class="navbar-dropdown">
                <a href="https://legacy.vitraag.com" class="navbar-item" target="_blank">       
                  <span class="icon">
                    <i class="fa fa-world"></i>
                  </span>
                  <span>Old Website&nbsp;</span>
                  <span class="tag is-primary">2001</span>
                </a>
              </div>
            </div>

            <a class="navbar-item" href="https://www.vitraag.com/#resume">
              <span class="icon">
                <i class="fas fa-file-alt"></i>
              </span>
              <span>Resume</span>
            </a>
          </div>
        </div>
  </div>
</nav>



<!-- 2023-11-29: Disabling hero for now.
<section class="hero is-info is-medium is-bold">
  <div class="hero-body">
      <div class="container has-text-centered">
         <h1 class="title">Kubernetes The Beast</h1> 
      </div>
  </div>
</section>
-->

<div class="container">
  <!-- START ARTICLE FEED -->
  <section class="articles">
      <div class="column is-8 is-offset-2">
          <!-- START ARTICLE -->
          <div class="card article">
              <div class="card-content">
                  <div class="media">
                      <div class="media-content has-text-centered">
                          <p class="title article-title">Kubernetes The Beast</p>
                          <div class="tags has-addons level-item">
                              <span class="tag is-rounded is-info">Vaibhav Bhandari</span>
                              <span class="tag is-rounded">Thu Feb 22 18:41:42 2024</span>
                              <span class="tag is-rounded is-warning">cloud, code</span>
                          </div>
                      </div>
                  </div>
                  <div class="content article-body">
                    <p>Over last week I ended up creating a kubernetes setup with following:</p>

<ul>
  <li>React Frontend</li>
  <li>Flask Backend with flask-sqlalchemy</li>
  <li>Postgres Database</li>
  <li>Nginx reverse proxy</li>
  <li>Hosted in Google cloud</li>
</ul>

<p>The setup was inspired by (this repo)[]. I learnt to use k9s and kubectl.</p>

<p>Here is how I did the containers, and kubernetes over 3-4 days.</p>

<h2 id="frontend">frontend</h2>

<h3 id="dockerfile">Dockerfile</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM --platform=linux/amd64 node:16-alpine

ADD . /frontend
WORKDIR /frontend
RUN npm install --silent

EXPOSE 3000

RUN npm run build
CMD ["npm", "start"]
</code></pre></div></div>

<h3 id="kubernetes">Kubernetes</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  labels:
    app: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: react-frontend
        image: vaibhavb/frontend:23
        imagePullPolicy: Always
        ports:
        - containerPort: 3000
        env:
        - name: HOST
          value: 0.0.0.0
        - name: DANGEROUSLY_DISABLE_HOST_CHECK
          value: "true"
---
apiVersion: v1
kind: Service
metadata:
  name: react-service
  labels:
    app: frontend
spec:
  type: ClusterIP
  selector:
    app: frontend
  ports:
  - port: 3000
    targetPort: 3000
</code></pre></div></div>

<h2 id="backend">backend</h2>
<h3 id="dockerfile-1">Dockerfile</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM --platform=linux/amd64 python:3.7 as build

RUN mkdir /app
WORKDIR /app
ADD . /app/
RUN pip install -r requirements.txt

ENV DATABASE_URI="localhost"
ENV FLASK_APP=main.py

EXPOSE 5000
CMD ["python", "/app/main.py"]
</code></pre></div></div>

<h3 id="kubernetes-1">kubernetes</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  labels:
    app: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: flask-backend
        image: vaibhavb/backend:12
        imagePullPolicy: Always
        ports:
        - containerPort: 5000
        env:
        - name: DATABASE_URI
          value: pg-service
---
apiVersion: v1
kind: Service
metadata:
  name: flask-service
  labels:
    app: backend
spec:
  type: ClusterIP
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000
</code></pre></div></div>
<h2 id="postgres">postgres</h2>
<h3 id="dockerfile-2">Dockerfile</h3>
<p>None</p>

<h3 id="kubernetes-2">kubernetes</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
data:
  CreateDB.sql: |-
    CREATE TABLE text (
        id serial PRIMARY KEY,
        text VARCHAR ( 100 ) UNIQUE NOT NULL
    );
    INSERT INTO text (text) VALUES ('List of questions below!');
    CREATE TABLE quiz_question (
    id INT PRIMARY KEY,
    question TEXT NOT NULL,
    answer1 TEXT NOT NULL,
    answer2 TEXT NOT NULL,
    answer3 TEXT NOT NULL,
    answer4 TEXT NOT NULL,
    correct_answer INT NOT NULL CHECK(correct_answer BETWEEN 1 AND 4)
    );
    INSERT INTO quiz_question (id, question, answer1, answer2, answer3, answer4, correct_answer) VALUES
      (1, 'What does OSINT stand for?', 'Open System Intelligence', 'Operational Security Intelligence', 'Open Source Intelligence', 'Operational Source Integration', 3),

kind: ConfigMap
metadata:
  name: pg-init-script
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  labels:
    app: database
spec:
  replicas: 1
  selector:
    matchLabels:
      app: database
  template:
    metadata:
      labels:
        app: database
    spec:
      containers:
      - name: postgres
        image: postgres
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: sqlscript
          mountPath: /docker-entrypoint-initdb.d
        env:
          - name: POSTGRES_USER
            value: "postgres"
          - name: POSTGRES_PASSWORD
            value: "postgres"
      volumes:
        - name: sqlscript
          configMap:
            name: pg-init-script
---
apiVersion: v1
kind: Service
metadata:
  name: pg-service
  labels:
    app: database
spec:
  type: ClusterIP
  selector:
    app: database
  ports:
  - port: 5432
</code></pre></div></div>

<h2 id="ingress-controller">ingress controller</h2>
<h3 id="dockerfile-3">Dockerfile</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm install ingress-nginx ingress-nginx/ingress-nginx \
                                      --set controller.ingressClass="ingress-nginx"
</code></pre></div></div>

<h3 id="kubernetes-3">kubernetes</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kubectlpython-ingress
spec:
  ingressClassName: nginx
  tls:
  rules:
  - host: kubectl.vitraag.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: flask-service
            port:
              number: 5000
      - path: /
        pathType: Prefix
        backend:
          service:
            name: react-service
            port:
              number: 3000
</code></pre></div></div>
<h2 id="google-cloud">google cloud</h2>
<p>I use the following script to bring the cluster up and down:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"down"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span>gcloud container clusters resize <span class="o">[[</span>CLUSTER_NAME]] <span class="nt">--node-pool</span> default-pool <span class="nt">--num-nodes</span> 0 <span class="nt">--zone</span> <span class="o">[[</span>ZONE_NAME]] <span class="nt">--project</span> <span class="o">[[</span>PROJECT_NAME]]
<span class="k">elif</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"up"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span>gcloud container clusters resize <span class="o">[[</span>CLUSTER_NAME]] <span class="nt">--node-pool</span> default-pool <span class="nt">--num-nodes</span> 1 <span class="nt">--zone</span> <span class="o">[[</span>ZONE_NAME]] <span class="nt">--project</span> <span class="o">[[</span>PROJECT_NAME]]
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Usage: ./cluster.sh down|up"</span>
<span class="k">fi</span>

</code></pre></div></div>
<h2 id="bugs">bugs</h2>

<ol>
  <li>I still can’t get the containers to use the latest tag</li>
  <li>Multi-platform build for Docker</li>
</ol>

                  </div>
              </div>
          </div>
      </div> 
</section>
<hr/>
<section>
<div class="container">
  <h3 class="title is-5">Related posts you may enjoy: </h3>
  <div class="columns">
  
  
  

 
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
        <div class="column is-onethird">
          <a href="/2024/06/18/desktop-setup/">
              <div class="rel">
                  <h5>Desktop Setup</h5>
              </div>
          </a>
        </div>
      
      
    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
        <div class="column is-onethird">
          <a href="/2024/05/27/wisevoter-update/">
              <div class="rel">
                  <h5>WiseVoter Update</h5>
              </div>
          </a>
        </div>
      
      
    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
  

   
    
    

    

    
        <div class="column is-onethird">
          <a href="/2024/04/17/understanding-javascript-promises/">
              <div class="rel">
                  <h5>Understanding Javascript Promises</h5>
              </div>
          </a>
        </div>
      
      
        
</div>
</div>
</section>


<hr/>
<footer class="footer">
    <div class="section-heading">
      <p>
        <a href="https://www.twitter.com/vaibhavb"><i class="fab fa-twitter-square fa-2x"></i></a> 
        <a href="https://www.github.com/vaibhavb"><i class="fab fa-github fa-2x"></i></a>
        <a href="https://www.linkedin.com/in/vaibhavb"><i class="fab fa-linkedin fa-2x"></i></a>
        <a href="http://legacy.vitraag.com/cse/index.html"><i class="fas fa-globe fa-2x"></i></a>
        <br/><strong>&copy; 2023 Vaibhav Bhandari</strong>
        <br/><span class="credit">Last Updated on Wed Aug 21 22:35:12 2024</span>
      </p>
    </div>
</footer>
<script async src="https://www.vitraag.com//assets/js/main.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MQQHR1JXTN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MQQHR1JXTN');
</script>
</body>
</html>
